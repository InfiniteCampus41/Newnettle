<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>
            Chat App
        </title>
        <script src="/socket.io/socket.io.js">
        </script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <style>
            * { 
                box-sizing: border-box; 
                margin: 0; 
                padding: 0; 
            }
            body { 
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background: #1e1e2f;
                color: #f0f0f0;
                display: flex;
                flex-direction: row;
                height: 100vh;
                overflow: hidden;
            }
            #left {
                width: 250px;
                background: #2c2c3e;
                display: flex;
                flex-direction: column;
                padding: 15px;
                overflow-y: auto;
                transition: transform 0.3s ease;
            }
            #left h3 { 
                margin-bottom: 10px; 
                color: #ddd; 
            }
            #channels div { 
                margin-bottom: 5px; 
                display: flex; 
                align-items: center; 
            }
            #channels button {
                flex: 1;
                background: #3a3a4f;
                color: #f0f0f0;
                border: none;
                padding: 8px 12px;
                border-radius: 8px;
                text-align: left;
                transition: background 0.2s;
            }
            #channels button:hover { 
                background: #555570; 
                cursor: pointer; 
            }
            #newChannel, #logout, #left a button {
                width: 100%;
                margin-top: 8px;
                padding: 10px;
                background: #3a3a4f;
                border-radius: 8px;
                border: none;
                color: #f0f0f0;
                transition: 0.2s;
            }
            #newChannel:hover, #logout:hover, #left a button:hover { 
                background: #555570; 
                cursor: pointer; 
            }
            #main {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: #1e1e2f;
                overflow: hidden;
            }
            #chat {
                flex: 1;
                padding: 15px;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            .message {
                background: #2c2c3e;
                padding: 10px 15px;
                border-radius: 12px;
                position: relative;
                word-break: break-word;
            }
            .message-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .message-header-left {
                display: flex;
                align-items: center;
                gap: 8px;
            }
            .message .username {
                font-weight: bold;
            }
            .message .time {
                font-size: 0.75em;
                color: #aaa;
            }
            .message .content { 
                margin: 5px 0 2px 44px; 
            }
            .message .edited { 
                font-size: 0.7em; 
                color: #888; 
                margin-left: 44px; 
            }
            .message-buttons { 
                margin-left: 44px; 
                margin-top: 5px; 
            }
            .pfp {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                object-fit: cover;
                border: 1px solid #888;
            }
            .editBtn, .deleteBtn {
                background: #444;
                color: white;
                border-radius: 6px;
                border: none;
                padding: 4px 8px;
                margin-right: 5px;
                font-size: 0.8em;
                transition: 0.2s;
            }
            .editBtn:hover, .deleteBtn:hover { 
                background: #666; 
                cursor: pointer; 
            }
            #bottom {
                display: flex;
                padding: 10px;
                background: #2c2c3e;
                gap: 10px;
            }
            #msg {
                flex: 1;
                resize: none;
                border-radius: 12px;
                border: none;
                padding: 10px;
                background: #3a3a4f;
                color: #f0f0f0;
                font-size: 1em;
                max-height: 150px;
            }
            #send {
                width: 90px;
                border: none;
                border-radius: 12px;
                background: #4a90e2;
                color: white;
                font-weight: bold;
                cursor: pointer;
                transition: 0.2s;
            }
            #send:hover { 
                background: #357ABD; 
            }
            #chat::-webkit-scrollbar { 
                width: 8px; 
            }
            #chat::-webkit-scrollbar-thumb { 
                background: #555; 
                border-radius: 4px; 
            }
            @media (max-width: 768px) {
                body { 
                    flex-direction: column; 
                }
                #left {
                    position: fixed;
                    top: 0;
                    left: 0;
                    height: 100%;
                    transform: translateX(-260px);
                    z-index: 1000;
                }
                #left.show { 
                    transform: translateX(0); 
                }
                #toggleSidebar {
                    display: block;
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    z-index: 1100;
                    background: #4a90e2;
                    border: none;
                    color: white;
                    padding: 8px 12px;
                    border-radius: 8px;
                    cursor: pointer;
                }
                #main { 
                    flex: 1; 
                    margin-top: 50px; 
                }
                #bottom { 
                    flex-direction: column; 
                    gap: 5px; 
                }
                #send { 
                    width: 100%; 
                }
            }
            #toggleSidebar { 
                display: none; 
            }
        </style>
    </head>
    <body>
        <button id="toggleSidebar">
            ☰
        </button>
        <div id="left">
            <p id="authStatus">
            </p>
            <h3>
                Channels
            </h3>
            <div id="channels">
            </div>
            <button id="newChannel" style="display:none;">
                + Channel
            </button>
            <hr>
            <a href="/settings.html">
                <button>
                    Settings
                </button>
            </a>
            <button id="logout">
                Logout
            </button>
            <br>
            <br>
        </div>
        <div id="main">
            <div id="chat">
            </div>
            <div id="bottom">
                <textarea  rows="2" type="text" id="msg" placeholder="Message"></textarea>
                <button id="send">
                    Send
                </button>
            </div>
        </div>
        <script>
            const socket = io();
            let user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                location.href = '/login.html';
            }
            const loginBtn = document.getElementById("login");
            const signupBtn = document.getElementById("signup");
            const sendBtn = document.getElementById("send");
            const status = document.getElementById("authStatus");
            const input = document.getElementById('msg');
            let currentChannel = 'general';
            const channelList = document.getElementById('channels');
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    if (e.shiftKey) {
                        const start = input.selectionStart;
                        const end = input.selectionEnd;
                        input.value = input.value.substring(0, start) + "\n" + input.value.substring(end);
                        input.selectionStart = input.selectionEnd = start + 1;
                        e.preventDefault();
                    } else {
                        e.preventDefault();
                        sendBtn.click();
                    }
                }
            });
            document.getElementById('logout').onclick = () => {
                localStorage.removeItem('user');
                location.href = '/login.html';
            };
            sendBtn.onclick = () => {
                if (!user || !currentChannel) return currentChannel = 'general';
                socket.emit('message', {
                    userId: user.id,
                    channelId: currentChannel,
                    content: msg.value
                });
                msg.value = '';
            };
            function formatTime(dateStr) {
                const d = new Date(dateStr);
                return d.toLocaleTimeString();
            }
            function renderMessage(msg) {
                const div = document.createElement('div');
                div.className = 'message';
                div.dataset.id = msg.id;
                const canModerate = user && (msg.userId === user.id || user.role === 'owner');
                const isMine = user && msg.userId === user.id;
                div.innerHTML=`
                    <div class="message-header">
                        <div class="message-header-left">
                            ${msg.profilePic?`<img class="pfp" src="${msg.profilePic}">`:''}
                            <span class="username" style="color:${msg.color}">${msg.username}${msg.role==='owner'?'<i class="bi bi-shield-fill-check" title="Owner"></i>':''}</span>
                        </div>
                        <span class="time">${formatTime(msg.timestamp)}</span>
                    </div>
                    <div class="content">${msg.content.replace(/\n/g,'<br>')}</div>
                    ${msg.edited?'<span class="edited">(edited)</span>':''}
                    ${canModerate?`<div class="message-buttons"><button class="editBtn">Edit</button><button class="deleteBtn">Delete</button></div>`:''}
                `;
                if (canModerate) {
                    div.querySelector('.editBtn').onclick = () => {
                        const newText = prompt("Edit message:", msg.content);
                        if (newText && newText !== msg.content) {
                            socket.emit('edit', {
                                messageId: msg.id,
                                userId: user.id,
                                newContent: newText
                            });
                        }
                    };
                    div.querySelector('.deleteBtn').onclick = () => {
                        socket.emit('delete', {
                            messageId: msg.id,
                            userId: user.id
                        });
                    };
                }
                document.getElementById('chat').appendChild(div);
            }
            socket.on('channels', channels => {
                channelList.innerHTML = '';
                channels.forEach(c => {
                    const wrapper = document.createElement('div');
                    wrapper.style.marginBottom = '5px';
                    const btn = document.createElement('button');
                    btn.textContent = `# ${c.name}`;
                    btn.onclick = () => {
                        currentChannel = c.id;
                        document.getElementById('chat').innerHTML = '';
                        socket.emit('join-channel', { channelId: c.id, user });
                    };
                    wrapper.appendChild(btn);
                    if (user?.role === 'owner') {
                        const settingsBtn = document.createElement('button');
                        settingsBtn.innerHTML = '⚙️';
                        settingsBtn.style.marginLeft = '5px';
                        settingsBtn.onclick = () => {
                            const action = prompt(
                                `Manage #${c.name}\n\n` +
                                `1 = Rename\n` +
                                `2 = Toggle Read (${c.canRead})\n` +
                                `3 = Toggle Write (${c.canWrite})\n` +
                                `4 = Delete`,
                            );
                            if (action === '1') {
                                const newName = prompt('New channel name:', c.name);
                                if (newName) {
                                    socket.emit('update-channel', {
                                        id: c.id,
                                        updates: { name: newName },
                                        user
                                    });
                                }
                            }
                            if (action === '2') {
                                socket.emit('update-channel', {
                                    id: c.id,
                                    updates: { canRead: !c.canRead },
                                    user
                                });
                            }
                            if (action === '3') {
                                socket.emit('update-channel', {
                                    id: c.id,
                                    updates: { canWrite: !c.canWrite },
                                    user
                                });
                            }
                            if (action === '4') {
                                if (confirm(`Delete #${c.name}? This cannot be undone.`)) {
                                    socket.emit('delete-channel', { id: c.id, user });
                                    if (currentChannel === c.id) {
                                        currentChannel = null;
                                        document.getElementById('chat').innerHTML = '';
                                    }
                                }
                            }
                        };
                        wrapper.appendChild(settingsBtn);
                    }
                    channelList.appendChild(wrapper);
                });
                if (user?.role === 'owner') {
                    document.getElementById('newChannel').style.display = 'block';
                }
            });
            document.getElementById('newChannel').onclick = () => {
                const name = prompt("Channel name");
                if (name) socket.emit('create-channel', { name, user });
            };
            socket.on('edit', msg => {
                const div = document.querySelector(`[data-id="${msg.id}"]`);
                if (!div) return;
                div.querySelector('.content').textContent = msg.content;
                if (!div.querySelector('.edited')) {
                    div.innerHTML += '<span class="edited">(edited)</span>';
                }
            });
            socket.on('delete', ({ id }) => {
                const div = document.querySelector(`[data-id="${id}"]`);
                if (div) div.remove();
            });
            if (user) {
                status.textContent = `Logged In As ${user.displayName}`;
            }
            socket.on('init', messages => {
                document.getElementById('chat').innerHTML = '';
                messages.forEach(m => renderMessage(m));
            });
            socket.on('message', msg => renderMessage(msg));
            const toggleSidebar=document.getElementById('toggleSidebar');
            toggleSidebar.onclick=()=> document.getElementById('left').classList.toggle('show');
        </script>
    </body>
</html>