<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>
            Chat App
        </title>
        <script src="/socket.io/socket.io.js">
        </script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
        <style>
            body { 
                font-family: sans-serif; 
                background:#222;
                color:white;
                display:flex;
                margin:0;
                height:100vh;
            }
            #left {
                justify-content:flex-start;
            }
            #main {
                width:100%;
                display:flow;
            }
            #chat { 
                width:100%;
            }
            #bottom {
                position:fixed;
                bottom:2px;
                width:100%;
                display:flex;
            }
            .message { 
                border-bottom: 1px solid #ddd; 
                padding: 5px; 
            }
            .username { 
                font-weight: bold; 
            }
            .reply { 
                margin-left: 20px; 
                border-left: 2px solid #ccc; 
                padding-left: 5px; 
                font-size: 0.9em; 
                color: gray;
            }
            .edited { 
                font-size: 0.7em; 
                color: #888; 
                margin-left: 45px; 
            }
            .content {
                margin-left:50px;
                margin-top:-7px;
            }
            .time { 
                font-size: 0.8em; 
                color: #888; 
                float: right; 
            }
            .pfp {
                width: 32px;
                border:1px solid white;
                height: 32px;
                border-radius: 50%;
                vertical-align: middle;
                margin-right: 6px;
                object-fit: cover;
            }
            #settings {
                display: none;
                border: 1px solid #444;
                padding: 10px;
                margin-top: 10px;
            }
            .editBtn, .deleteBtn {
                background:#444;
                color:white;
                border-radius:3px;
                border:1px solid white;
                transition:0.3s all;
            }
            .editBtn:hover, .deleteBtn:hover {
                background:#777;
                cursor:pointer;
            }
            #send {
                width:10%;
                height:50px;
            }
            #msg {
                width:70%;
                height:70px;
                background:#444;
                color:white;
                border:1px solid #888;
                border-radius:10px;
            }
            #send {
                color:white;
                background:#444;
                height:70px;
                width:10%;
                border:1px solid #888;
                border-radius:10px;
                transition:0.3s all;
            }
            #send:hover {
                background:#888;
            }
        </style>
    </head>
    <body>
        <div id="left">
            <p id="authStatus">
            </p>
            <button id="openSettings">
                Settings
            </button>
            <div id="settings">
                <h3>
                    Profile Settings
                </h3>
                <label>
                    Name Color:
                </label>
                <br>
                <input type="color" id="nameColor">
                <br>
                <br>
                <label>
                    Profile Picture:
                </label>
                <br>
                <input type="file" id="pfpInput" accept="image/*">
                <br>
                <br>
                <button id="saveSettings">
                    Save
                </button>
            </div>
            <br>
            <br>
            <input type="email" id="username" placeholder="email">
            <input type="text" id="displayName" placeholder="display name">
            <input type="password" id="password" placeholder="password">
            <button id="login">
                Login
            </button>
            <button id="signup">
                Sign Up
            </button>
        </div>
        <div id="main">
            <div id="chat">
            </div>
            <div id="bottom">
                <textarea  rows="2" type="text" id="msg" placeholder="Message"></textarea>
                <button id="send">
                    Send
                </button>
            </div>
        </div>
        <script>
            const socket = io();
            let user = JSON.parse(localStorage.getItem('user'));
            const loginBtn = document.getElementById("login");
            const signupBtn = document.getElementById("signup");
            const sendBtn = document.getElementById("send");
            const status = document.getElementById("authStatus");
            const settingsBtn = document.getElementById('openSettings');
            const settingsDiv = document.getElementById('settings');
            const saveSettingsBtn = document.getElementById('saveSettings');
            const nameColorInput = document.getElementById('nameColor');
            const pfpInput = document.getElementById('pfpInput');
            const input = document.getElementById('msg');
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    if (e.shiftKey) {
                        const start = input.selectionStart;
                        const end = input.selectionEnd;
                        input.value = input.value.substring(0, start) + "\n" + input.value.substring(end);
                        input.selectionStart = input.selectionEnd = start + 1;
                        e.preventDefault();
                    } else {
                        e.preventDefault();
                        sendBtn.click();
                    }
                }
            });
            settingsBtn.onclick = () => {
                if (!user) return alert("Log In First");
                settingsDiv.style.display =
                    settingsDiv.style.display === 'none' ? 'block' : 'none';
                nameColorInput.value = user.color || '#000000';
            };
            saveSettingsBtn.onclick = async () => {
                if (!user) return;
                const formData = new FormData();
                formData.append('id', user.id);
                formData.append('color', nameColorInput.value);
                if (pfpInput.files[0]) {
                    formData.append('pfp', pfpInput.files[0]);
                }
                const res = await fetch('/update-profile', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.ok) {
                    user = data.user;
                    localStorage.setItem('user', JSON.stringify(user));
                    alert("Profile Updated!");
                }
            };
            loginBtn.onclick = async () => {
                const email = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (!data.ok) {
                    status.textContent = data.message;
                    return;
                }
                user = data.user;
                localStorage.setItem('user', JSON.stringify(user));
                status.textContent = `Logged In As ${user.displayName}`;
            };
            signupBtn.onclick = async () => {
                const email = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const displayName = document.getElementById('displayName').value;
                const res = await fetch('/signup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, displayName })
                });
                const data = await res.json();
                if (!data.ok) {
                    status.textContent = data.message;
                    return;
                }
                user = data.user;
                localStorage.setItem('user', JSON.stringify(user));
                status.textContent = `Account Created! Logged In As ${user.displayName}`;
            };
            sendBtn.onclick = () => {
                if (!user) {
                    alert("You Must Log In First");
                    return;
                }
                const content = document.getElementById('msg').value;
                if (!content) return;
                socket.emit('message', {
                    userId: user.id,
                    content,
                    color: user.color
                });
                document.getElementById('msg').value = '';
            };
            function formatTime(dateStr) {
                const d = new Date(dateStr);
                return d.toLocaleTimeString();
            }
            function renderMessage(msg) {
                const div = document.createElement('div');
                div.className = 'message';
                div.dataset.id = msg.id;
                const canModerate = user && (msg.userId === user.id || user.role === 'owner');
                const isMine = user && msg.userId === user.id;
                div.innerHTML = `
                    ${msg.profilePic ? `<img class="pfp" src="${msg.profilePic}">` : ''}
                    <span class="username" style="color:${msg.color}">
                        ${msg.username}
                        ${msg.role === 'owner' ? '<i class="bi bi-shield-fill-check" title="Owner"></i>' : ''}
                    </span>
                    <span class="time">${formatTime(msg.timestamp)}</span>
                    <div class="content">${msg.content.replace(/\n/g, '<br>')}</div>
                    ${msg.edited ? '<span class="edited">(edited)</span><br>' : ''}
                    ${canModerate ? `
                        <button class="editBtn">Edit</button>
                        <button class="deleteBtn">Delete</button>
                    ` : ''}
                `;
                if (canModerate) {
                    div.querySelector('.editBtn').onclick = () => {
                        const newText = prompt("Edit message:", msg.content);
                        if (newText && newText !== msg.content) {
                            socket.emit('edit', {
                                messageId: msg.id,
                                userId: user.id,
                                newContent: newText
                            });
                        }
                    };
                    div.querySelector('.deleteBtn').onclick = () => {
                        socket.emit('delete', {
                            messageId: msg.id,
                            userId: user.id
                        });
                    };
                }
                document.getElementById('chat').appendChild(div);
            }
            socket.on('edit', msg => {
                const div = document.querySelector(`[data-id="${msg.id}"]`);
                if (!div) return;
                div.querySelector('.content').textContent = msg.content;
                if (!div.querySelector('.edited')) {
                    div.innerHTML += '<span class="edited">(edited)</span>';
                }
            });
            socket.on('delete', ({ id }) => {
                const div = document.querySelector(`[data-id="${id}"]`);
                if (div) div.remove();
            });
            if (user) {
                status.textContent = `Logged In As ${user.displayName}`;
                loginBtn.style.display = 'none';
                signupBtn.style.display = 'none';

                document.getElementById("username").style.display = 'none';
                document.getElementById("password").style.display = 'none';
                document.getElementById("displayName").style.display = 'none';
            }
            socket.on('init', messages => {
                document.getElementById('chat').innerHTML = '';
                messages.forEach(m => renderMessage(m));
            });
            socket.on('message', msg => renderMessage(msg));
        </script>
    </body>
</html>
